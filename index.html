<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>12 Pubs Route (Town) â€” Interactive Map</title>
  <link rel="stylesheet" href="mystyle.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

</head>

<body>
  <div id="map"></div>

  <!-- <div id="ui" class="ui open">
  <button id="menuBtn" class="menu-btn" type="button" aria-label="Toggle menu" aria-expanded="true">
    <span class="menu-icon"></span>
  </button>

  <div class="bubble panel" id="status">
    <h1>12 Pubs Route (Town)</h1>
    <p id="statusText">Loading pins + walking routesâ€¦ (first load may take ~10â€“20 seconds)</p>
    <div class="chip">Stop 8 (Flight Club) is the break point</div>
    <div class="btnrow">
      <button class="primary" id="fitBtn" disabled>Fit to route</button>
      <button id="toggle1" disabled>Toggle Part 1</button>
      <button id="toggle2" disabled>Toggle Part 2</button>
      <button id="followBtn">Follow me</button>
    </div>
  </div>
</div> -->

  <div id="ui" class="ui open">
    <div class="ui-left">
      <button id="menuBtn" class="menu-btn" type="button" aria-label="Toggle menu" aria-expanded="true">
        <span class="menu-icon"></span>
      </button>

      <button id="langBtn" class="menu-btn lang-btn" type="button" aria-label="Language" aria-expanded="false">
        ğŸŒ
      </button>

      <div id="langMenu" class="lang-menu hidden">
        <button type="button" data-lang="en">English</button>
        <button type="button" data-lang="ja">æ—¥æœ¬èª</button>
        <button type="button" data-lang="ko">í•œêµ­ì–´</button>
        <button type="button" data-lang="ga">Gaeilge</button>
      </div>
    </div>

    <div class="bubble panel" id="status">
      <h1 id="titleText">12 Pubs Route (Town)</h1>
      <p id="statusText">Loading pins + walking routesâ€¦ (first load may take ~10â€“20 seconds)</p>
      <div class="chip" id="chipText">Stop 8 (Flight Club) is the break point</div>

      <div class="btnrow">
        <button class="primary" id="fitBtn" disabled>Fit to route</button>
        <button id="toggle1" disabled>Toggle Part 1</button>
        <button id="toggle2" disabled>Toggle Part 2</button>
        <button id="followBtn">Follow me</button>
      </div>
    </div>
  </div>

  <script>
    // const STOPS = [{ n: 1, name: "The Wild Duck", addr: "The Wild Duck, Sycamore Street, Dublin 2, Ireland" }, { n: 2, name: "Tapped Late Bar & Kitchen", addr: "47 Nassau St, Dublin D02 RP20, Ireland" }, {"n": 3, "name": "Pygmalion", "addr": "Pygmalion, 59 South William Street, Dublin 2, Ireland"}, {"n": 4, "name": "The Hairy Lemon", "addr": "The Hairy Lemon, Stephen Street Lower, Dublin 2, Ireland"}, {"n": 5, "name": "Bar With No Name", "addr": "Bar With No Name, 3 Fade Street, Dublin 2, Ireland"}, {"n": 6, "name": "CafÃ© en Seine", "addr": "CafÃ© en Seine, 40 Dawson Street, Dublin 2, Ireland"}, {"n": 7, "name": "37 Dawson Street", "addr": "37 Dawson Street, 37 Dawson Street, Dublin 2, Ireland"}, { n: 8, name: "Flight Club Dublin", addr: "35-36 Dawson Street, Dublin, Ireland" }, {"n": 9, "name": "Whelan's", "addr": "Whelan's, 25 Wexford Street, Dublin 2, Ireland"}, {"n": 10, "name": "The Camden", "addr": "The Camden, 84 Camden Street Lower, Dublin 2, Ireland"}, {"n": 11, "name": "Devitt's Pub", "addr": "Devitt's Pub, 78 Camden Street Lower, Dublin 2, Ireland"}, {"n": 12, "name": "The Bleeding Horse", "addr": "The Bleeding Horse, 24-25 Camden Street Upper, Dublin 2, Ireland"}];
    const STOPS = [{
        n: 1,
        name: "The Wild Duck",
        addr: "17-20 Sycamore St, Temple Bar, Dublin 2, Ireland",
        note: "Kick-off spot. Lively, chatty, good 'everyone meet here' energy.",
        rule: "No First Names <br> No one can call each other by their first name. If someone slips up, they get a penalty drink.",
        website: "https://www.instagram.com/thewildduckdublin/",
        photos: [
          "images/WildDuck1.png",
          "images/WildDuck2.png",
          "images/WildDuck3.png"
        ],
        maps: "https://maps.app.goo.gl/vpxH4MaMDLyBRaG58",
        i18n: {
          ja: {
            note: "ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã€‚ã«ãã‚„ã‹ã§è©±ã—ã‚„ã™ã„ã€é›†åˆå ´æ‰€ã«ã´ã£ãŸã‚Šã®é›°å›²æ°—ã€‚",
            rule: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ç¦æ­¢<br>ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã§å‘¼ã¶ã®ã¯ç¦æ­¢ã€‚èª°ã‹ãŒè¨€ã£ãŸã‚‰ãƒšãƒŠãƒ«ãƒ†ã‚£ãƒ‰ãƒªãƒ³ã‚¯ã€‚"
          },
          ko: {
            note: "ì¶œë°œ ì§€ì . í™œê¸°ì°¨ê³  ë¶„ìœ„ê¸° ì¢‹ì•„ì„œ â€˜ì—¬ê¸°ì„œ ëª¨ì´ìâ€™ í•˜ê¸° ë”± ì¢‹ì•„ìš”.",
            rule: "ì´ë¦„ ë¶€ë¥´ê¸° ê¸ˆì§€<br>ì„œë¡œ ì´ë¦„(í¼ìŠ¤íŠ¸ë„¤ì„) ë¶€ë¥´ë©´ ì•ˆ ë¨. ì‹¤ìˆ˜í•˜ë©´ ë²Œì¹™ ìˆ !"
          },
          ga: {
            note: "An tÃºs. FuinniÃºil agus sÃ³isialtaâ€”foirfe mar Ã¡it chruinnithe don ghrÃºpa.",
            rule: "Gan CÃ©adanmneacha<br>NÃ¡ glaoigh ar Ã©inne lena chÃ©adainm. MÃ¡ theipeann ort, pionÃ³s deoch!"
          }
        }
      },
      {
        n: 2,
        name: "Tapped Late Bar & Kitchen",
        addr: "Nassau St, Dublin 2, Ireland",
        note: "Cozy-but-busy early stop. Handy for a quick cocktail + food base. Great atmosphere + good for groups. Solid early stop.",
        rule: "Opposite Hand Drinking <br> You must drink with your non-dominant hand in one of the pubs. If caught using the wrong hand, you owe a drink to someone.",
        website: "https://tappeddublin.com/",
        photos: [
          "images/tapped.png",
          "images/tapped2.png",
          "images/tapped3.png"
        ],
        maps: "https://www.google.com/maps/search/?api=1&query=Tapped%20Late%20Bar%20%26%20Kitchen%20Dublin",
        i18n: {
          ja: {
            note: "åºç›¤ã«ã¡ã‚‡ã†ã©ã„ã„ã€ã»ã©ã‚ˆãæ··ã‚€å±…å¿ƒåœ°ã®è‰¯ã„ãŠåº—ã€‚è»½ãä¸€æ¯ï¼‹è»½é£Ÿã«ã‚‚â—ã€‚",
            rule: "é€†ã®æ‰‹ã§é£²ã‚€<br>ã©ã“ã‹1è»’ã¯åˆ©ãæ‰‹ã˜ã‚ƒãªã„æ–¹ã§é£²ã‚€ã€‚é–“é•ãˆãŸã‚‰èª°ã‹ã«1æ¯ãŠã”ã‚Šã€‚"
          },
          ko: {
            note: "ì´ˆë°˜ì— ê°€ê¸° ì¢‹ì€ ì•„ëŠ‘í•œ ê³³. í•œì” + ì•ˆì£¼/ìŒì‹ìœ¼ë¡œ ë² ì´ìŠ¤ ê¹”ê¸° ì¢‹ì•„ìš”.",
            rule: "ë°˜ëŒ€ì†ìœ¼ë¡œ ë§ˆì‹œê¸°<br>í•œ íì—ì„œëŠ” ë¹„ì£¼ì†ìœ¼ë¡œë§Œ ë§ˆì‹œê¸°. ë“¤í‚¤ë©´ ëˆ„êµ°ê°€ì—ê²Œ í•œì”!"
          },
          ga: {
            note: "Stop luath compordach. OiriÃºnach do dheoch thapa agus greim biaâ€”maith don ghrÃºpa.",
            rule: "Ã“l leis an LÃ¡mh Eile<br>I dtÃ¡bhairne amhÃ¡in, Ã³l leis an lÃ¡mh neamhcheannasach. MÃ¡ fhaightear thÃº, caithfidh tÃº deoch a cheannach do dhuine."
          }
        }
      },
      {
        n: 3,
        name: "Pygmalion",
        addr: "59 William St S, Dublin 2, Ireland",
        note: "Fun atmosphere + big beer garden vibes. Great momentum stop.",
        rule: "Silent Pub <br> One pub must be completed in total silence. No talking, just gestures. First person to talk faces a penalty!",
        website: "https://pyg.ie/",
        photos: [
          "images/Pygmalion1.png",
          "images/Pygmalion2.png",
          "images/Pygmalion3.png",
          "images/Pygmalion4.png",
          "images/Pygmalion5.png"
        ],
        maps: "https://maps.app.goo.gl/p9gv6ZGFDWWbC4mg6",
        i18n: {
          ja: {
            note: "æ¥½ã—ã„é›°å›²æ°—ï¼‹ãƒ“ã‚¢ã‚¬ãƒ¼ãƒ‡ãƒ³æ„Ÿã€‚ãƒ†ãƒ³ãƒãŒä¸ŠãŒã‚‹å‹¢ã„ã®ã‚ã‚‹ä¸€è»’ã€‚",
            rule: "ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ‘ãƒ–<br>ã©ã“ã‹1è»’ã¯å®Œå…¨ã«ç„¡è¨€ã§ã€‚ã—ã‚ƒã¹ã£ãŸäººã¯ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼"
          },
          ko: {
            note: "ë¶„ìœ„ê¸° ì¢‹ê³  ë¹„ì–´ê°€ë“  ëŠë‚Œ. ê¸°ì„¸ ì˜¬ë¦¬ê¸° ì¢‹ì€ ìŠ¤íŒŸ.",
            rule: "ë¬´ìŒ í<br>í•œ íì€ ì™„ì „ ì¹¨ë¬µ. ë§í•œ ì‚¬ëŒì´ ë²Œì¹™!"
          },
          ga: {
            note: "AtmaisfÃ©ar spraÃ­Ãºil agus vibes gairdÃ­n beorach. Stop maith chun mÃ³iminteam a thÃ³gÃ¡il.",
            rule: "TÃ¡bhairne CiÃºin<br>I dtÃ¡bhairne amhÃ¡in, bÃ­odh sÃ© i dtost iomlÃ¡n. An chÃ©ad duine a labhraÃ­onnâ€”pionÃ³s!"
          }
        }
      },
      {
        n: 4,
        name: "The Bar With No Name",
        addr: "Fade Street, Dublin 2, Ireland",
        note: "Hidden-feel cocktail bar. Good 'reset' for chats before the next push.",
        rule: "Last One Done <br> Whoever finishes their drink last in this pub faces an extra challenge in the next pub (e.g., doing a shot, carrying someone's drink, etc.).",
        website: "https://www.noname.bar/",
        photos: [
          "images/BarNoName1.png",
          "images/BarNoName2.png",
          "images/BarNoName3.png"
        ],
        maps: "https://maps.app.goo.gl/wFXWCXAuqYAPKgRi9",
        i18n: {
          ja: {
            note: "éš ã‚Œå®¶ã£ã½ã„ã‚«ã‚¯ãƒ†ãƒ«ãƒãƒ¼ã€‚æ¬¡ã«å‚™ãˆã¦è½ã¡ç€ã„ã¦è©±ã›ã‚‹â€œãƒªã‚»ãƒƒãƒˆâ€æ ã€‚",
            rule: "æœ€å¾Œã«é£²ã¿çµ‚ãˆãŸäºº<br>ã“ã®åº—ã§æœ€å¾Œã«é£²ã¿çµ‚ãˆãŸäººã¯ã€æ¬¡ã®åº—ã§è¿½åŠ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã€‚"
          },
          ko: {
            note: "ìˆ¨ì€ ëŠë‚Œì˜ ì¹µí…Œì¼ ë°”. ë‹¤ìŒ ë¼ìš´ë“œ ì „ì— ë¶„ìœ„ê¸° ë¦¬ì…‹í•˜ê¸° ì¢‹ì•„ìš”.",
            rule: "ë§ˆì§€ë§‰ìœ¼ë¡œ ë‹¤ ë§ˆì‹  ì‚¬ëŒ<br>ì—¬ê¸°ì„œ ê°€ì¥ ëŠ¦ê²Œ ëë‚¸ ì‚¬ëŒì€ ë‹¤ìŒ íì—ì„œ ì¶”ê°€ ë¯¸ì…˜!"
          },
          ga: {
            note: "BeÃ¡r mhanglaim le vibe â€˜rÃºndaâ€™. Deas mar stad athshocraithe roimh an gcÃ©ad chÃ©im eile.",
            rule: "An Duine Deireanach<br>An tÃ© a chrÃ­ochnaÃ­onn a dheoch deireanach anseoâ€”faigheann dÃºshlÃ¡n breise sa chÃ©ad tÃ¡bhairne eile."
          }
        }
      },
      {
        n: 5,
        name: "The Hairy Lemon",
        addr: "41-42 Stephen St Lower, Dublin 2, Ireland",
        note: "Quirky Dublin pub energy. Easy mid-route pint + laughs.",
        rule: "The Straw Rule <br> Everyone's drink must be consumed through a straw at one pub. Bonus points if it's a festive one!",
        website: "https://thehairylemon.ie/",
        photos: [
          "images/HairyLemon1.png",
          "images/HairyLemon2.png",
          "images/HairyLemon3.png",
          "images/HairyLemon4.png"
        ],
        maps: "https://maps.app.goo.gl/epKEbP7duajogBue8",
        i18n: {
          ja: {
            note: "ã¡ã‚‡ã£ã¨ã‚¯ã‚»ã«ãªã‚‹ãƒ€ãƒ–ãƒªãƒ³ã£ã½ã•ã€‚ä¸­ç›¤ã®ä¸€æ¯ã«ã¡ã‚‡ã†ã©ã„ã„ã€‚",
            rule: "ã‚¹ãƒˆãƒ­ãƒ¼ç¸›ã‚Š<br>ã©ã“ã‹1è»’ã¯å…¨å“¡ã‚¹ãƒˆãƒ­ãƒ¼ã§é£²ã‚€ã€‚ã‚¯ãƒªã‚¹ãƒã‚¹ã£ã½ã„ã‚¹ãƒˆãƒ­ãƒ¼ãªã‚‰åŠ ç‚¹ï¼"
          },
          ko: {
            note: "íŠ¹ìœ ì˜ ë”ë¸”ë¦° ê°ì„±. ì¤‘ê°„ì— í•œì”í•˜ê³  ì›ƒê¸° ì¢‹ì€ ê³³.",
            rule: "ë¹¨ëŒ€ ê·œì¹™<br>í•œ íì—ì„œëŠ” ì „ì› ë¹¨ëŒ€ë¡œë§Œ ë§ˆì‹œê¸°. í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë¹¨ëŒ€ë©´ ë³´ë„ˆìŠ¤!"
          },
          ga: {
            note: "FÃ­or-Dhubhlinneach agus greannmhar. Stop lÃ¡r-rÃºit le pionta agus gÃ¡ire.",
            rule: "Riail an TuÃ­<br>I dtÃ¡bhairne amhÃ¡in, Ã³ltar gach deoch trÃ­ thuÃ­. BÃ³nas mÃ¡ tÃ¡ ceann fÃ©ile!"
          }
        }
      },

      {
        n: 6,
        name: "CafÃ© en Seine",
        addr: "40 Dawson St, Dublin 2, Ireland",
        note: "Big 'wow' interior. Perfect for group photos + fancy drinks.",
        rule: "Stranger Sip <br> In one pub, you must get a stranger to take a drink with you. No leaving until you succeed!",
        website: "https://cafeenseine.ie/",
        photos: [
          "images/CafÃ©enSeine1.png",
          "images/CafÃ©enSeine2.png",
          "images/CafÃ©enSeine3.png",
          "images/CafÃ©enSeine4.png",
          "images/CafÃ©enSeine5.png",
        ],
        maps: "https://maps.app.goo.gl/hNGjWT3hVAEbEQM49",
        i18n: {
          ja: {
            note: "å†…è£…ãŒâ€œã‚ãâ€ã£ã¦ãªã‚‹ã€‚å†™çœŸã«ã‚‚æœ€é«˜ã€ã¡ã‚‡ã£ã¨ã‚ªã‚·ãƒ£ãƒ¬ã«é£²ã‚ã‚‹ã€‚",
            rule: "ã‚¹ãƒˆãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼ãƒ»ã‚·ãƒƒãƒ—<br>ã©ã“ã‹1è»’ã§çŸ¥ã‚‰ãªã„äººã«ä¸€ç·’ã«ä¸€å£é£²ã‚“ã§ã‚‚ã‚‰ã†ã€‚æˆåŠŸã™ã‚‹ã¾ã§å‡ºã‚‰ã‚Œãªã„ï¼"
          },
          ko: {
            note: "ì¸í…Œë¦¬ì–´ê°€ â€˜ì™€â€™ ì†Œë¦¬ ë‚˜ì˜¤ëŠ” ê³³. ë‹¨ì²´ ì‚¬ì§„ + ë¶„ìœ„ê¸° ìˆê²Œ ë§ˆì‹œê¸° ì¢‹ì•„ìš”.",
            rule: "ë‚¯ì„  ì‚¬ëŒ í•œ ëª¨ê¸ˆ<br>í•œ íì—ì„œ ë‚¯ì„  ì‚¬ëŒì—ê²Œ ê°™ì´ í•œ ëª¨ê¸ˆ ë§ˆì…”ë‹¬ë¼ê³  í•˜ê¸°. ì„±ê³µ ì „ì—” ëª» ë‚˜ê°!"
          },
          ga: {
            note: "Taobh istigh â€˜wowâ€™. Foirfe do ghrianghraif ghrÃºpa agus deochanna galÃ¡nta.",
            rule: "Sip le StrainsÃ©ir<br>I dtÃ¡bhairne amhÃ¡in, faigh strainsÃ©ir le sip a ghlacadh leat. NÃ­ fhÃ¡gann sibh go dtÃ­ go n-Ã©ireoidh libh!"
          }
        }
      },
      {
        n: 7,
        name: "37 Dawson Street",
        addr: "37 Dawson St, Dublin 2, Ireland",
        note: "Stylish, good atmosphere, easy to actually talk (before the chaos).",
        rule: "Jumper Swap <br> At this pub, everyone must swap Christmas jumpers with someone else in the group. No exceptions, no complaints!",
        website: "https://37dawsonstreet.ie/",
        photos: [
          "images/37DawsonStreet1.png",
          "images/37DawsonStreet2.png",
          "images/37DawsonStreet3.png",
        ],
        maps: "https://maps.app.goo.gl/rWzrjD6bBiYK67Jc6",
        i18n: {
          ja: {
            note: "ãŠã—ã‚ƒã‚Œã§é›°å›²æ°—è‰¯ã—ã€‚é¨’ãŒã—ããªã‚Šã™ããšã€ã¡ã‚ƒã‚“ã¨è©±ã›ã‚‹ç³»ã€‚",
            rule: "ã‚¸ãƒ£ãƒ³ãƒ‘ãƒ¼äº¤æ›<br>ã“ã“ã§ã¯å…¨å“¡ã‚¯ãƒªã‚¹ãƒã‚¹ã‚¸ãƒ£ãƒ³ãƒ‘ãƒ¼ã‚’èª°ã‹ã¨äº¤æ›ã€‚ä¾‹å¤–ãªã—ï¼"
          },
          ko: {
            note: "ì„¸ë ¨ë˜ê³  ë¶„ìœ„ê¸° ì¢‹ì•„ìš”. ë„ˆë¬´ ì‹œë„ëŸ½ì§€ ì•Šì•„ ëŒ€í™”ë„ ê°€ëŠ¥í•œ í¸.",
            rule: "í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ìŠ¤ì›¨í„° êµí™˜<br>ì—¬ê¸°ì„œëŠ” ì „ì› ìŠ¤ì›¨í„°ë¥¼ ì„œë¡œ ë°”ê¿” ì…ê¸°. ì˜ˆì™¸ ì—†ìŒ!"
          },
          ga: {
            note: "StÃ­leÃ¡il agus atmaisfÃ©ar deasâ€”Ã¡it mhaith le comhrÃ¡ sula dtÃ©ann an oÃ­che as smacht.",
            rule: "MalartÃº GeansaÃ­<br>Sa tÃ¡bhairne seo, caithfidh gach duine geansaÃ­ Nollag a mhalartÃº le duine eile. Gan eisceacht!"
          }
        }
      },
      {
        n: 8,
        name: "Flight Club Dublin",
        // addr: "Dawson St, Dublin 2, Ireland",
        addr: "35/36 Dawson St, Dublin, D02 CR29, Ireland",
        lat: 53.3406928,
        lon: -6.2584398,
        note: "Your break-point ğŸ˜‚ Darts games + loud energy + mayhem (not a nightclub).",
        rule: "Switch Seats Rule <br> Everyone must swap seats randomly each time you take a drink during this pub. No one can sit where they started.",
        website: "https://flightclubdarts.com/ie/dublin/",
        photos: [
          "images/FlightClubDublin1.png",
          "images/FlightClubDublin2.png",
          "images/FlightClubDublin3.png",
        ],
        maps: "https://maps.app.goo.gl/u3iaKEtQstMNCapU9",
        i18n: {
          ja: {
            note: "ä¼‘æ†©ãƒã‚¤ãƒ³ãƒˆğŸ˜‚ ãƒ€ãƒ¼ãƒ„ï¼‹è³‘ã‚„ã‹ï¼‹ã‚«ã‚ªã‚¹ï¼ˆã‚¯ãƒ©ãƒ–ã˜ã‚ƒãªãã¦ãƒãƒ¼å¯„ã‚Šï¼‰ã€‚",
            rule: "å¸­ã‚·ãƒ£ãƒƒãƒ•ãƒ«<br>ã“ã®åº—ã§ã¯é£²ã‚€ãŸã³ã«ãƒ©ãƒ³ãƒ€ãƒ ã«å¸­æ›¿ãˆã€‚æœ€åˆã®å¸­ã«ã¯æˆ»ã‚Œãªã„ã€‚"
          },
          ko: {
            note: "íœ´ì‹ í¬ì¸íŠ¸ ğŸ˜‚ ë‹¤íŠ¸ + ì‹œëŒë²…ì  + ë‚œì¥(í´ëŸ½ ë§ê³  ë°” ëŠë‚Œ).",
            rule: "ìë¦¬ ë°”ê¾¸ê¸°<br>ì—¬ê¸°ì„œëŠ” ë§ˆì‹¤ ë•Œë§ˆë‹¤ ëœë¤ìœ¼ë¡œ ìë¦¬ êµì²´. ì²˜ìŒ ì•‰ì€ ìë¦¬ì— ëª» ì•‰ìŒ!"
          },
          ga: {
            note: "Pointe sosa ğŸ˜‚ CluichÃ­ dairteanna agus fuinneamh ardâ€”beagÃ¡n craiceÃ¡ilte (ach nÃ­ club oÃ­che).",
            rule: "Riail an Mhalartaithe SuÃ­ochÃ¡n<br>Gach uair a Ã³lann tÃº, malartaigh suÃ­ochÃ¡in go randamach. NÃ­ fÃ©idir fanacht sa chÃ©ad Ã¡it a bhÃ­ agat."
          }
        }
      },
      {
        n: 9,
        name: "Whelan's",
        addr: "25 Wexford St, Dublin 2, Ireland",
        note: "Live-music vibe. Great for a singalong moment and proper craic.",
        rule: "Person to Your Left Picks <br> At one pub, the person to your left picks your drink. No complaints allowed!",
        website: "https://www.whelanslive.com/",
        photos: [
          "images/Whelans1.png",
          "images/Whelans2.png",
          "images/Whelans3.png",
        ],
        maps: "https://maps.app.goo.gl/EgzjzWUBpC8RWDH17",
        i18n: {
          ja: {
            note: "ãƒ©ã‚¤ãƒ–éŸ³æ¥½ã£ã½ã„é›°å›²æ°—ã€‚æ­Œã„ãŸããªã‚‹â€œã„ã„æ„Ÿã˜â€ã®ä¸€è»’ã€‚",
            rule: "å·¦ã®äººãŒæ±ºã‚ã‚‹<br>ã©ã“ã‹1è»’ã§ã€å·¦éš£ã®äººãŒã‚ãªãŸã®é£²ã¿ç‰©ã‚’é¸ã¶ã€‚æ–‡å¥ãªã—ï¼"
          },
          ko: {
            note: "ë¼ì´ë¸Œ ìŒì•… ë¶„ìœ„ê¸°. ë‹¤ ê°™ì´ ë”°ë¼ ë¶€ë¥´ê¸° ì¢‹ì€ ìŠ¤íŒŸ.",
            rule: "ì™¼ìª½ ì‚¬ëŒì´ ê³ ë¥´ê¸°<br>í•œ íì—ì„œëŠ” ì™¼ìª½ ì‚¬ëŒì´ ë„¤ ìŒë£Œë¥¼ ì„ íƒ. ë¶ˆí‰ ê¸ˆì§€!"
          },
          ga: {
            note: "Vibe ceoil bheo. Stop iontach le hamhrÃ¡n agus craic.",
            rule: "An Duine Ar ChlÃ© a RoghnaÃ­onn<br>I dtÃ¡bhairne amhÃ¡in, roghnaÃ­onn an duine ar do chlÃ© do dheoch. Gan gearÃ¡in!"
          }
        }
      },
      {
        n: 10,
        name: "The Camden",
        addr: "84 Camden St Lower, Dublin 2, Ireland",
        note: "High-energy bar atmosphere (dancey, but still a bar). Big group-friendly stop.",
        rule: "No Swearing <br> Swearing is banned at this pub. Slip up, and you owe a penalty drink!",
        website: "https://thecamden.ie/",
        photos: [
          "images/Camden1.png",
          "images/Camden2.png",
          "images/Camden3.png",
        ],
        maps: "https://maps.app.goo.gl/WFDUvLjJ7UQBwfq69",
        i18n: {
          ja: {
            note: "ã‚¨ãƒãƒ«ã‚®ãƒ¼é«˜ã‚ã§ã‚°ãƒ«ãƒ¼ãƒ—å‘ãã€‚è¸Šã‚Œã‚‹ã‘ã©â€œãƒãƒ¼â€ã®ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã€‚",
            rule: "æ‚ªå£/æ±šã„è¨€è‘‰ç¦æ­¢<br>ã“ã“ã§ã¯ç½µã‚Šè¨€è‘‰ï¼ˆã‚¹ã‚¦ã‚§ã‚¢ï¼‰ç¦æ­¢ã€‚è¨€ã£ãŸã‚‰ãƒšãƒŠãƒ«ãƒ†ã‚£ãƒ‰ãƒªãƒ³ã‚¯ï¼"
          },
          ko: {
            note: "ì—ë„ˆì§€ ë†’ì€ ë°”. ë‹¨ì²´ë¡œ ê°€ê¸° ì¢‹ê³  ë¶„ìœ„ê¸° ì—…ë˜ëŠ” ê³³.",
            rule: "ìš• ê¸ˆì§€<br>ì—¬ê¸°ì„œëŠ” ìš•ì„¤ ê¸ˆì§€. ì‹¤ìˆ˜í•˜ë©´ ë²Œì¹™ ìˆ !"
          },
          ga: {
            note: "Fuinneamh ard agus oiriÃºnach do ghrÃºpaÃ­. BeÃ¡r â€˜beagnach damhsaâ€™ ach fÃ³s beÃ¡r.",
            rule: "Gan MionnÃº<br>TÃ¡ mionnÃº toirmiscthe anseo. MÃ¡ tharlaÃ­onn sÃ©â€”pionÃ³s deoch!"
          }
        }
      },
      {
        n: 11,
        name: "Devitt's Pub",
        addr: "78 Camden St Lower, Dublin 2, Ireland",
        note: "Solid pints + classic good atmosphere. Usually a handy late-route stop.",
        rule: "No Phones <br> Phones are banned in one pub. If youâ€™re caught using your phone, you do a shot at the next place.",
        website: "https://devittspub.ie/",
        photos: [
          "images/Devitts1.png",
          "images/Devitts2.png",
          "images/Devitts3.png",
        ],
        maps: "https://maps.app.goo.gl/bdWfP7tvc1dugzgq5",
        i18n: {
          ja: {
            note: "å®šç•ªã®è‰¯ã„ãƒ‘ã‚¤ãƒ³ãƒˆï¼‹é›°å›²æ°—ã€‚çµ‚ç›¤ã«ã¡ã‚‡ã†ã©ã„ã„å®‰å®šæ ã€‚",
            rule: "ã‚¹ãƒãƒ›ç¦æ­¢<br>ã©ã“ã‹1è»’ã¯ã‚¹ãƒãƒ›ç¦æ­¢ã€‚è§¦ã£ã¦ãŸã‚‰æ¬¡ã®åº—ã§ã‚·ãƒ§ãƒƒãƒˆã€‚"
          },
          ko: {
            note: "í´ë˜ì‹í•œ í ë¶„ìœ„ê¸° + ê´œì°®ì€ ë§¥ì£¼. í›„ë°˜ì— ì•ˆì •ì ìœ¼ë¡œ ê°€ê¸° ì¢‹ì•„ìš”.",
            rule: "íœ´ëŒ€í° ê¸ˆì§€<br>í•œ íì—ì„œëŠ” íœ´ëŒ€í° ì‚¬ìš© ê¸ˆì§€. ë“¤í‚¤ë©´ ë‹¤ìŒ íì—ì„œ ìƒ·!"
          },
          ga: {
            note: "PiontaÃ­ maithe agus atmaisfÃ©ar clasaiceach. Stop Ã¡isiÃºil go dÃ©anach sa rÃºit.",
            rule: "Gan FÃ³in<br>I dtÃ¡bhairne amhÃ¡in, tÃ¡ fÃ³in toirmiscthe. MÃ¡ fhaightear thÃº ag ÃºsÃ¡id fÃ³nâ€”shot sa chÃ©ad Ã¡it eile."
          }
        }
      },
      {
        n: 12,
        name: "The Bleeding Horse",
        addr: "24-25 Camden St Upper, Dublin 2, Ireland",
        note: "Finish line. Big classic pub, plenty of space to end the night properly.",
        rule: "Accents Only <br> For one pub, everyone must speak in an accent (e.g., American, Scottish, pirate). Break character? Take a drink!",
        website: "https://bleedinghorse.ie/",
        // photo: "https://upload.wikimedia.org/wikipedia/commons/c/c6/The_Bleeding_Horse%2C_Dublin_01.jpg",
        photos: [
          "images/TheBleedingHorse1.png",
          "images/TheBleedingHorse2.png",
          "images/TheBleedingHorse3.png",
          "images/TheBleedingHorse4.png",
          "images/TheBleedingHorse5.png",
        ],
        maps: "https://maps.app.goo.gl/t95EkoQH2ttWrWYy7",
        i18n: {
          ja: {
            note: "ã‚´ãƒ¼ãƒ«ï¼åºƒã‚ã®ã‚¯ãƒ©ã‚·ãƒƒã‚¯ãƒ‘ãƒ–ã§ç· ã‚ã«ã´ã£ãŸã‚Šã€‚",
            rule: "ã‚¢ã‚¯ã‚»ãƒ³ãƒˆç¸›ã‚Š<br>ã©ã“ã‹1è»’ã¯å…¨å“¡ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã§è©±ã™ï¼ˆä¾‹ï¼šã‚¢ãƒ¡ãƒªã‚«ã€ã‚¹ã‚³ãƒƒãƒˆãƒ©ãƒ³ãƒ‰ã€æµ·è³Šï¼‰ã€‚å´©ã‚ŒãŸã‚‰ä¸€å£ã€‚"
          },
          ko: {
            note: "ê³¨ì¸ ì§€ì ! ë„“ê³  í´ë˜ì‹í•œ íì´ë¼ ë§ˆë¬´ë¦¬í•˜ê¸° ë”± ì¢‹ì•„ìš”.",
            rule: "ì–µì–‘/ì‚¬íˆ¬ë¦¬ë¡œë§Œ ë§í•˜ê¸°<br>í•œ íì—ì„œëŠ” ì „ì› ì–µì–‘(ë¯¸êµ­, ìŠ¤ì½”í‹€ëœë“œ, í•´ì  ë“±)ìœ¼ë¡œë§Œ ë§í•˜ê¸°. ê¹¨ì§€ë©´ í•œì”!"
          },
          ga: {
            note: "An lÃ­ne chrÃ­ochnaithe. TÃ¡bhairne clasaiceach mÃ³râ€”go leor spÃ¡is chun an oÃ­che a chrÃ­ochnÃº i gceart.",
            rule: "Accents AmhÃ¡in<br>I dtÃ¡bhairne amhÃ¡in, labhair gach duine le blas/accaint (m.sh. MeiriceÃ¡nach, Albanach, bradach). MÃ¡ bhriseann tÃº carachtarâ€”glac deoch!"
          }
        }
      }
    ];

    let currentLang = localStorage.getItem("lang") || "en";

    const I18N = {
      en: {
        title: "12 Pubs Route (Town)",
        chip: "Stop 8 (Flight Club) is the break point",
        loading: "Loading pins + walking routesâ€¦ (first load may take ~10â€“20 seconds)",
        geocoding: "Geocoding locationsâ€¦",
        routing: "Building walking routesâ€¦",
        done: "Done âœ… Zoom in/out like Google Maps. Tap pins for details.",
        fit: "Fit to route",
        t1: "Toggle Part 1",
        t2: "Toggle Part 2",
        follow: "Follow me",
        following: "Following âœ…",
        rulePrefix: "Rule:",
        openMaps: "Open in Google Maps",
        website: "Website"
      },
      ja: {
        title: "12ãƒ‘ãƒ–ã¯ã—ã”ãƒ«ãƒ¼ãƒˆï¼ˆå¸‚å†…ï¼‰",
        chip: "8ç•ªï¼ˆFlight Clubï¼‰ãŒä¼‘æ†©ãƒã‚¤ãƒ³ãƒˆ",
        loading: "ãƒ”ãƒ³ã¨å¾’æ­©ãƒ«ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­â€¦ï¼ˆåˆå›ã¯10ã€œ20ç§’ã»ã©ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰",
        geocoding: "å ´æ‰€ã‚’æ¤œç´¢ä¸­â€¦",
        routing: "å¾’æ­©ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆä¸­â€¦",
        done: "å®Œäº† âœ… ã‚ºãƒ¼ãƒ ã—ã¦ã€ãƒ”ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è©³ç´°ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚",
        fit: "ãƒ«ãƒ¼ãƒˆã«åˆã‚ã›ã‚‹",
        t1: "ãƒ‘ãƒ¼ãƒˆ1 åˆ‡æ›¿",
        t2: "ãƒ‘ãƒ¼ãƒˆ2 åˆ‡æ›¿",
        follow: "ç¾åœ¨åœ°ã‚’è¿½è·¡",
        following: "è¿½è·¡ä¸­ âœ…",
        rulePrefix: "ãƒ«ãƒ¼ãƒ«:",
        openMaps: "Googleãƒãƒƒãƒ—ã§é–‹ã",
        website: "ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ"
      },
      ko: {
        title: "12í ë£¨íŠ¸(ë„ì‹¬)",
        chip: "8ë²ˆ(Flight Club)ì´ íœ´ì‹ í¬ì¸íŠ¸",
        loading: "í•€ê³¼ ë„ë³´ ê²½ë¡œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦(ì²˜ìŒì—ëŠ” 10~20ì´ˆ ê±¸ë¦´ ìˆ˜ ìˆì–´ìš”)",
        geocoding: "ì¥ì†Œë¥¼ ì°¾ëŠ” ì¤‘â€¦",
        routing: "ë„ë³´ ê²½ë¡œë¥¼ ë§Œë“œëŠ” ì¤‘â€¦",
        done: "ì™„ë£Œ âœ… í™•ëŒ€/ì¶•ì†Œí•˜ê³  í•€ì„ ëˆŒëŸ¬ ìì„¸íˆ ë³´ì„¸ìš”.",
        fit: "ê²½ë¡œì— ë§ì¶”ê¸°",
        t1: "1ë¶€ í† ê¸€",
        t2: "2ë¶€ í† ê¸€",
        follow: "ë‚´ ìœ„ì¹˜ ë”°ë¼ê°€ê¸°",
        following: "ì¶”ì  ì¤‘ âœ…",
        rulePrefix: "ê·œì¹™:",
        openMaps: "Google ì§€ë„ì—ì„œ ì—´ê¸°",
        website: "ì›¹ì‚¬ì´íŠ¸"
      },
      ga: {
        title: "Bealach 12 dTÃ¡bhairne (LÃ¡r na Cathrach)",
        chip: "Is Ã© Stad 8 (Flight Club) an pointe sosa",
        loading: "BiorÃ¡in agus bealaÃ­ siÃºil Ã¡ luchtÃºâ€¦ (10â€“20 soicind uaireanta ar an gcÃ©ad uair)",
        geocoding: "SuÃ­omhanna Ã¡ ngeochÃ³dÃºâ€¦",
        routing: "BealaÃ­ siÃºil Ã¡ gcruthÃºâ€¦",
        done: "DÃ©anta âœ… ZÃºmÃ¡il isteach/amach agus tapÃ¡il na biorÃ¡in le sonraÃ­ a fheiceÃ¡il.",
        fit: "Feistigh ar an mbealach",
        t1: "Cuid 1 a thaispeÃ¡int/a cheilt",
        t2: "Cuid 2 a thaispeÃ¡int/a cheilt",
        follow: "Lean mo shuÃ­omh",
        following: "Ag leanÃºint âœ…",
        rulePrefix: "Riail:",
        openMaps: "Oscail i Google Maps",
        website: "SuÃ­omh GrÃ©asÃ¡in"
      }
    };

    function t(key) {
      return (I18N[currentLang] && I18N[currentLang][key]) || I18N.en[key] || key;
    }

    // Optional per-pub translations:
    // s.i18n = { ja:{note:"", rule:""}, ko:{...}, ga:{...} }
    function getStopText(s, field) {
      if (s.i18n && s.i18n[currentLang] && s.i18n[currentLang][field]) return s.i18n[currentLang][field];
      return s[field] || "";
    }

    let lastStatusKey = "loading";

    function setStatusKey(key) {
      lastStatusKey = key;
      statusText.textContent = t(key);
    }

    function applyLanguage() {
      document.getElementById("titleText").textContent = t("title");
      document.getElementById("chipText").textContent = t("chip");
      fitBtn.textContent = t("fit");
      toggle1.textContent = t("t1");
      toggle2.textContent = t("t2");
      followBtn.textContent = followUser? t("following") : t("follow");
      statusText.textContent = t(lastStatusKey);
    }


    // Map
    const map = L.map('map', {
      zoomControl: true
    });

    // --- User location (blue dot) ---
    let userMarker = null;
    let userCircle = null;
    let followUser = false;

    function updateUserLocation(e) {
      const latlng = e.latlng;
      const accuracy = e.accuracy || 0;

      if (!userMarker) {
        userMarker = L.circleMarker(latlng, {
          radius: 8,
          weight: 3,
          color: "#1a73e8",
          fillColor: "#1a73e8",
          fillOpacity: 0.9
        }).addTo(map);

        userCircle = L.circle(latlng, {
          radius: accuracy,
          weight: 1,
          color: "#1a73e8",
          fillColor: "#1a73e8",
          fillOpacity: 0.15
        }).addTo(map);
      } else {
        userMarker.setLatLng(latlng);
        userCircle.setLatLng(latlng);
        userCircle.setRadius(accuracy);
      }

      if (followUser) map.setView(latlng, Math.max(map.getZoom(), 16));
    }

    function onLocationError(err) {
      console.warn(err);
      alert("Couldn't get your location. Make sure location services are enabled and allow the browser permission.");
    }

    // Start watching location (updates as you walk)
    map.locate({
      watch: true,
      setView: false,
      enableHighAccuracy: true,
      maximumAge: 5000
    });
    map.on("locationfound", updateUserLocation);
    map.on("locationerror", onLocationError);

    map.setView([53.344, -6.261], 15);

    // Basemap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const statusText = document.getElementById('statusText');
    const fitBtn = document.getElementById('fitBtn');
    const toggle1 = document.getElementById('toggle1');
    const toggle2 = document.getElementById('toggle2');

    const followBtn = document.getElementById('followBtn');
    followBtn.onclick = () => {
      followUser = !followUser;
      followBtn.textContent = followUser? t("following") : t("follow");
    };

    applyLanguage();
    setStatusKey("loading");

    // --- Burger menu open/close ---
    const ui = document.getElementById("ui");
    const menuBtn = document.getElementById("menuBtn");

    function setMenu(open) {
      ui.classList.toggle("closed", !open);
      ui.classList.toggle("open", open);
      menuBtn.setAttribute("aria-expanded", open? "true" : "false");
    }

    // default: OPEN (like now)
    setMenu(true);

    menuBtn.addEventListener("click", () => {
      const isOpen = !ui.classList.contains("closed");
      setMenu(!isOpen);
    });

    const markersLayer = L.layerGroup().addTo(map);
    const route1Layer = L.geoJSON(null, {
      style: {
        color: '#7c3aed',
        weight: 6,
        opacity: 0.95
      }
    }).addTo(map);
    const route2Layer = L.geoJSON(null, {
      style: {
        color: '#7c3aed',
        weight: 6,
        opacity: 0.60,
        dashArray: '10 10'
      }
    }).addTo(map);

    function makeIcon(n, isBreak) {
      const cls = isBreak? 'num-pin break' : 'num-pin';
      return L.divIcon({
        className: '',
        html: `<div class="${cls}">${n}</div>`,
        iconSize: [34, 34],
        iconAnchor: [17, 17],
        popupAnchor: [0, -18]
      });
    }

    async function geocodeOne(query) {
      const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(query);
      const res = await fetch(url, {
        headers: {
          'Accept': 'application/json'
        }
      });
      if (!res.ok) throw new Error('Geocoding failed: ' + res.status);
      const data = await res.json();
      if (!data || !data[0]) throw new Error('No result for: ' + query);
      return {
        lat: parseFloat(data[0].lat),
        lon: parseFloat(data[0].lon)
      };
    }

    async function routeOSRM(coords) {
      const coordStr = coords.map(c => `${c.lon},${c.lat}`).join(';');
      const url =
        `https://routing.openstreetmap.de/routed-foot/route/v1/foot/${coordStr}?overview=full&geometries=geojson&steps=false`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Routing failed: ' + res.status);
      const json = await res.json();
      if (!json.routes || !json.routes[0] || !json.routes[0].geometry) throw new Error('No route geometry');
      return json.routes[0].geometry;
    }

    function setStatus(msg) {
      statusText.textContent = msg;
    }

    (async () => {
      try {
        setStatusKey("geocoding");
        const coords = [];

        function popupHtmlForStop(s) {
          const safe = (v) => (v ? String(v).replaceAll('"', "&quot;") : "");

          const noteText = getStopText(s, "note");
          const ruleText = getStopText(s, "rule");

          const photos = Array.isArray(s.photos) ? s.photos : [];
          const dotsHtml = photos.map((_, i) => `<span class="dot" data-idx="${i}"></span>`).join("");

          const carouselHtml = photos.length ? `
            <div class="carousel" data-stop="${s.n}">
              <button class="car-btn prev" type="button" data-dir="-1">â€¹</button>
              <img class="car-img" src="${safe(photos[0])}" loading="lazy" onerror="this.style.display='none';" />
              <button class="car-btn next" type="button" data-dir="1">â€º</button>
              <div class="car-dots">${dotsHtml}</div>
            </div>
          ` : "";

          const noteHtml = noteText
            ? `<div style="margin-top:6px;color:#56606a;line-height:1.35">${safe(noteText)}</div>`
            : "";

          const ruleHtml = `<div class="pub-rule">${t("rulePrefix")} ${safe(ruleText || "")}</div>`;

          const buttonsHtml = `
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
              ${s.maps ? `<a href="${safe(s.maps)}" target="_blank" rel="noopener"
                style="background:#7c3aed;color:#fff;padding:8px 10px;border-radius:10px;text-decoration:none;font-weight:700;font-size:12px">
                ${t("openMaps")}</a>` : ""}
              ${s.website ? `<a href="${safe(s.website)}" target="_blank" rel="noopener"
                style="background:#fff;color:#111;border:1px solid rgba(0,0,0,.15);padding:8px 10px;border-radius:10px;text-decoration:none;font-weight:700;font-size:12px">
                ${t("website")}</a>` : ""}
            </div>
          `;

          return `
            <div style="max-width:320px">
              <div style="font-weight:900;font-size:14px">${s.n}. ${safe(s.name)}</div>
              <div style="color:#56606a;font-size:12px;margin-top:2px">${safe(s.addr)}</div>
              ${carouselHtml}
              ${noteHtml}
              ${ruleHtml}
              ${buttonsHtml}
            </div>
          `;
        }

        for (let i = 0; i < STOPS.length; i++) {
          const s = STOPS[i];
          const c = (s.lat && s.lon)? {
            lat: s.lat,
            lon: s.lon
          } : await geocodeOne(s.addr);
          coords.push(c);

          const isBreak = (s.n === 8);
          const m = L.marker([c.lat, c.lon], {
            icon: makeIcon(s.n, isBreak)
          });
          const safe = (v) => (v? String(v).replaceAll('"', "&quot;") : "");

          const photoHtml = s.photo?
            `<img src="${safe(s.photo)}"
                  style="width:100%;max-height:160px;object-fit:cover;border-radius:12px;margin:8px 0"
                  loading="lazy"
                  onerror="this.style.display='none';" />` :
            "";

          // const noteHtml = s.note
          //  ? `<div style="margin-top:6px;color:#56606a;line-height:1.35">${safe(s.note)}</div>`
          //   : "";

          const buttonsHtml = `
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
            ${s.maps? `<a href="${safe(s.maps)}" target="_blank" rel="noopener"
                        style="background:#7c3aed;color:#fff;padding:8px 10px;border-radius:10px;text-decoration:none;font-weight:700;font-size:12px">
                        ${t("openMaps")}</a>` : ""}
            ${s.website? `<a href="${safe(s.website)}" target="_blank" rel="noopener"
                          style="background:#fff;color:#111;border:1px solid rgba(0,0,0,.15);padding:8px 10px;border-radius:10px;text-decoration:none;font-weight:700;font-size:12px">
                          ${t("website")}</a>` : ""}
          </div>
        `;

          // const ruleHtml = `<div class="pub-rule">Rule: ${safe(s.rule?? "")}</div>`;

          const noteText = getStopText(s, "note");
          const ruleText = getStopText(s, "rule");

          const noteHtml = noteText?
            `<div style="margin-top:6px;color:#56606a;line-height:1.35">${safe(noteText)}</div>` :
            "";

          const ruleHtml = `<div class="pub-rule">${t("rulePrefix")} ${safe(ruleText?? "")}</div>`;


          // const safe = (v) => (v? String(v).replaceAll('"', "&quot;") : "");

          const photos = Array.isArray(s.photos)? s.photos : [];
          const dotsHtml = photos.map((_, i) => `<span class="dot" data-idx="${i}"></span>`).join("");

          const carouselHtml = photos.length?
            `
            <div class="carousel" data-stop="${s.n}">
              <button class="car-btn prev" type="button" data-dir="-1">â€¹</button>
              <img class="car-img" src="${safe(photos[0])}" loading="lazy"
                  onerror="this.style.display='none';" />
              <button class="car-btn next" type="button" data-dir="1">â€º</button>
              <div class="car-dots">${dotsHtml}</div>
            </div>
          ` :
            "";

          m.bindPopup(() => popupHtmlForStop(s), { maxWidth: 340 });

        //   m.bindPopup(() => popupHtmlForStop(s), { maxWidth: 340 });
        //   <div style="max-width:320px">
        //     <div style="font-weight:900;font-size:14px">${s.n}. ${safe(s.name)}</div>
        //     <div style="color:#56606a;font-size:12px;margin-top:2px">${safe(s.addr)}</div>
        //     ${carouselHtml}
        //     ${s.desc? `<div style="margin-top:6px;color:#56606a;font-size:12px;line-height:1.35">${safe(s.desc)}</div>` : ""}
        //     ${noteHtml}
        //     ${ruleHtml}
        //     ${buttonsHtml}
        //   </div>
        // `, {
        //     maxWidth: 340
        //   });

          // m.bindPopup(`
          //   <div style="max-width:320px">
          //     <div style="font-weight:900;font-size:14px">${s.n}. ${safe(s.name)}</div>
          //     <div style="color:#56606a;font-size:12px;margin-top:2px">${safe(s.addr)}</div>
          //     ${photoHtml}
          //     ${noteHtml}
          //     ${buttonsHtml}
          //   </div>
          // `);

          m.addTo(markersLayer);

          await new Promise(r => setTimeout(r, 350));
        }

        setStatusKey("routing");
        const part1 = coords.slice(0, 8);
        const part2 = coords.slice(7, 12); // start from stop 8

        const geom1 = await routeOSRM(part1);
        route1Layer.addData({
          "type": "Feature",
          "geometry": geom1,
          "properties": {
            "name": "Part 1"
          }
        });

        const geom2 = await routeOSRM(part2);
        route2Layer.addData({
          "type": "Feature",
          "geometry": geom2,
          "properties": {
            "name": "Part 2"
          }
        });

        const allLatLngs = coords.map(c => L.latLng(c.lat, c.lon));
        const bounds = L.latLngBounds(allLatLngs).pad(0.18);
        map.fitBounds(bounds);

        fitBtn.disabled = false;
        toggle1.disabled = false;
        toggle2.disabled = false;

        fitBtn.onclick = () => map.fitBounds(bounds);
        toggle1.onclick = () => (map.hasLayer(route1Layer)? map.removeLayer(route1Layer) : route1Layer.addTo(map));
        toggle2.onclick = () => (map.hasLayer(route2Layer)? map.removeLayer(route2Layer) : route2Layer.addTo(map));

        applyLanguage();

        setStatusKey("done");
      } catch (e) {
        console.error(e);
        setStatus('Couldnâ€™t load map routes: ' + (e.message || e));
      }
    })();

    const langBtn = document.getElementById("langBtn");
    const langMenu = document.getElementById("langMenu");

    langBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isHidden = langMenu.classList.toggle("hidden");
      langBtn.setAttribute("aria-expanded", isHidden? "false" : "true");
    });

    document.addEventListener("click", (e) => {
      if (!langMenu.contains(e.target) && e.target !== langBtn) {
        langMenu.classList.add("hidden");
        langBtn.setAttribute("aria-expanded", "false");
      }
    });

    langMenu.addEventListener("click", (e) => {
      const b = e.target.closest("button[data-lang]");
      if (!b) return;

      currentLang = b.dataset.lang;
      localStorage.setItem("lang", currentLang);

      langMenu.classList.add("hidden");
      langBtn.setAttribute("aria-expanded", "false");

      const wasOpenPopup = map._popup;           // current open popup (if any)
      const source = wasOpenPopup?._source;     // marker that owns it

      map.closePopup();
      applyLanguage();

      if (source) source.openPopup();            // reopen â†’ popupHtmlForStop runs again
    });


    const STOP_BY_N = Object.fromEntries(STOPS.map(x => [x.n, x]));
    const carState = {}; // stopNumber -> currentIndex

    function renderCarousel(rootEl, stopN) {
      const stop = STOP_BY_N[stopN];
      if (!stop || !stop.photos?.length) return;

      const idx = carState[stopN] ?? 0;
      const img = rootEl.querySelector(".car-img");
      const dots = [...rootEl.querySelectorAll(".dot")];

      if (img) img.src = stop.photos[idx];
      dots.forEach((d, i) => d.classList.toggle("active", i === idx));
    }

    map.on("popupopen", (e) => {
      const popupEl = e.popup.getElement();
      const car = popupEl?.querySelector(".carousel");
      if (!car) return;

      const stopN = Number(car.dataset.stop);
      const stop = STOP_BY_N[stopN];
      if (!stop?.photos?.length) return;

      carState[stopN]??= 0;

      // bind once per popup DOM
      if (car.dataset.bound !== "1") {
        car.addEventListener("click", (ev) => {
          const btn = ev.target.closest(".car-btn");
          const dot = ev.target.closest(".dot");

          if (btn) {
            const dir = Number(btn.dataset.dir);
            const len = stop.photos.length;
            carState[stopN] = (carState[stopN] + dir + len) % len;
            renderCarousel(popupEl, stopN);
          }

          if (dot) {
            carState[stopN] = Number(dot.dataset.idx);
            renderCarousel(popupEl, stopN);
          }
        });

        car.dataset.bound = "1";
      }

      renderCarousel(popupEl, stopN);
    });
  </script>
</body>
</html>